**iFlowId**: SEDA_Model_-_Single_DS_-_Restart_and_Discard - **iFlowVersion**: 1.0.0

**Functional Summary**

- **Brief description of the iFlow**
This iFlow demonstrates a SEDA (Staged Event-Driven Architecture) pattern with a single Data Store consumer. It retrieves messages from a Data Store, processes them through several steps, and stores intermediate states back into the Data Store.  The iFlow handles exceptions at each processing step and provides retry and discard mechanisms based on the number of retries.

- **Involved systems**
    - Postman
    - DS (Data Store)

- **Used Adapters**
    - HTTPS (Sender)
    - DataStore Consumer (Sender)

- **Key steps**
    1. Receive message via HTTPS from Postman.
    2. Store headers for Sender, Receiver and MessageType.
    3. Persist the message in the Data Store (Step1) using the DataStore adapter.
    4. Consume messages from Data Store adapter
    5. Route the message to Step1, Step2, or Step3 based on the "Step" header.
    6. Each step persists the message to the Data Store (Step2, Step3).
    7. If the "SAP_DataStoreRetries" header exceeds "MaxRetries", the message is discarded.
    8. Exceptions are caught in subprocesses with status custom setting and logging to groovyscript Log_Exception_Async
    9. The Groovy Scripts Groovy_Logging_Scripts, Log_Discarded_Message, and Log_Exception_Async is called when discarding a message

- **Message transformation**
    - Header enrichment to set Sender, Receiver, MessageType, and Step for routing.
    - Custom status setting in the message processing log.
    - Groovy scripts are used for logging and exception handling.

- **Externalized parameters list and their descriptions**
    - {{RoleName}}: Role required for HTTPS sender authentication.
    - {{Maximum Retry Interval}}: Maximum retry interval for DataStore Consumer.
    - {{Exponential Backoff}}: Flag to enable exponential backoff for DataStore Consumer retries.
    - {{Data Store Name}}: Name of the Data Store.
    - {{Poll Interval}}: Poll interval for DataStore Consumer.
    - {{Retry Interval}}: Retry interval for DataStore Consumer.
    - {{Lock Timeout}}: Lock timeout for DataStore Consumer.
    - {{Retention Threshold 4 Alerting}}: Retention threshold for alerting in DB Storage.
    - {{Expiration Period}}: Expiration period for DB Storage.
    - {{MaxRetries}}: Maximum number of retries before discarding a message.

- **DataStore / JMS Dependency**
Yes

**Mermaid Diagram**

```mermaid
graph LR
    A[Postman] --> B(HTTPS Start Event)
    B --> C{Set Headers (Step 0)}
    C --> D(DataStore Put Step1)
    D --> E{Custom Status (Step0Completed)}
    E --> F(End Message)

    G[DataStore Consumer Start Event] --> H{Reprocess?}
    H -- Yes --> I{Step?}
    H -- Discard --> J(Discarded)
    J --> K(Log Discarded Message)
    K --> L(Discarded MaxRetries)

    I -- Step1 --> M{Set Headers (Step1)}
    I -- Step2 --> N{Set Headers (Step2)}
    I -- Step 3 --> O{Set Headers (Step 3)}
    I -- Unknown --> P{Custom Status (UnknownStep)}
    P --> F

    M --> Q(Step 1)
    N --> R(Step 2)
    O --> S(Step 3)

    Q --> T(DataStore Put Step2)
    R --> U(DataStore Put Step3)

    T --> V{Custom Status (Step1Completed)}
    U --> W{Custom Status (Step2Completed)}
    S --> X{Custom Status (Step3Completed)}

    V --> F
    W --> F
    X --> F

    subgraph Step 1 Exception Subprocess
    AA[Error Start 2] --> BB{Custom Status (Step1Exception)}
    BB --> CC(Log Async Exception)
    CC --> DD[Error End 1]
    end

    subgraph Step 2 Exception Subprocess
    EE[Error Start 3] --> FF{Custom Status (Step2Exception)}
    FF --> GG(Log Async Exception)
    GG --> HH[Error End 2]
    end

   subgraph Step 3 Exception Subprocess
    II[Error Start 4] --> JJ{Custom Status (Step3Exception)}
    JJ --> KK(Log Async Exception)
    KK --> LL[Error End 3]
    end
```
